# AGENTS.md

Configuration file for AI coding agents (e.g., Google Jules, GitHub Copilot).

---

## Core Philosophy / Project Context

`renvvv` is an R package that wraps [`renv`](https://rstudio.github.io/renv/)
to provide more robust package restore and update functions. Standard
`renv::restore()` stops on the first error; `renvvv` catches failures, retries
them individually, and reports what could not be installed — so you don't lose
progress on the packages that *can* be restored.

**Primary architectural patterns:**

- Exported functions delegate to internal engine helpers in `R/renv_helpers.R`.
- Error handling uses `tryCatch()` with `cli` alerts; failures are reported but
  execution continues.
- Functions return `invisible(TRUE)` on success.
- The package avoids global state modification (e.g., does not call
  `renv::activate()` silently without user confirmation in interactive
  sessions).

---

## Tech Stack & Tooling

| Layer | Choice |
|---|---|
| Language | R (>= 4.1 recommended) |
| Package manager / lockfile | `renv` |
| CLI output | `cli` |
| Documentation | `roxygen2` (Markdown-enabled) |
| Testing | `testthat` v3 (`Config/testthat/edition: 3`) |
| Optional Bioconductor install | `BiocManager` (Suggests) |
| Build tooling | `devtools`, `rcmdcheck` |
| Vignettes | `knitr` + `rmarkdown` |

**Do NOT use:**

- `base::message()` / `base::warning()` / `base::cat()` for user-facing
  output — use `cli::cli_alert_*()` instead.
- `library()` inside package source files — use `pkg::fun()` qualified calls.
- `=` for assignment — use `<-`.

---

## Setup Commands

### System dependencies (Ubuntu / Debian)

```bash
sudo apt-get update -y
sudo apt-get install --no-install-recommends -y \
  libcurl4-openssl-dev libfontconfig1-dev libfreetype6-dev \
  libgit2-dev libjpeg-dev libpng-dev libx11-dev pandoc \
  libharfbuzz-dev libfribidi-dev libtiff-dev
```

### R dependencies

```r
# Install devtools and roxygen2 if not already present
install.packages(c("devtools", "roxygen2", "rcmdcheck"))

# Install all package dependencies (declared in DESCRIPTION)
devtools::install_deps(dependencies = TRUE)
```

---

## Build & Test Instructions

```r
# 1. Regenerate documentation (NAMESPACE + man/ pages) — run after any
#    roxygen comment change
devtools::document()

# 2. Run all tests
devtools::test()

# 3. Run a single test file
testthat::test_file("tests/testthat/test-renv_dep_add.R")

# 4. Full R CMD check (builds docs, runs tests, checks package conventions)
devtools::check()
```

> **Before every commit:** run `devtools::document()`, `devtools::test()`, and
> `devtools::check()` to ensure the package is in a clean state.

---

## Coding Style & Conventions

### Formatting

- 2-space indentation; no tabs.
- Maximum line length: 80 characters.
- No trailing whitespace on any line (including blank lines).
- Always add a blank line between headings and bullet/code blocks in roxygen
  comments.

### Naming

| Kind | Pattern | Example |
|---|---|---|
| Exported functions | `renvvv_` prefix, `snake_case` | `renvvv_restore()` |
| Internal functions | `.` prefix, `snake_case` | `.renv_paths_lockfile()` |
| Test files | `test-<source_file_name>.R` | `test-renv_helpers.R` |

### Function structure

```r
renvvv_example <- function(pkg) {
  .check_renv()   # verify renv is available
  .ensure_cli()   # verify cli is available

  tryCatch(
    some_operation(pkg),
    error = function(e) {
      cli::cli_alert_danger("Failed: {e$message}")
    }
  )

  invisible(TRUE)
}
```

### Documentation

All exported functions must have complete roxygen2 blocks:

```r
#' @title Short title
#'
#' @description One-sentence description.
#'
#' @param x Description of parameter x.
#'
#' @return Invisibly returns `TRUE` upon completion.
#'
#' @examples
#' \dontrun{
#' renvvv_example("pkg")
#' }
#'
#' @export
```

### Dependencies

- **Imports** (`renv`, `cli`): always available; call directly.
- **Suggests** (`BiocManager`, `rcmdcheck`, `testthat`, etc.): guard with
  `requireNamespace("pkg", quietly = TRUE)` before use.

### Commits / PRs

- Write commit messages in the imperative mood (`Add`, `Fix`, `Update`).
- Keep each commit focused on a single logical change.
- Run `devtools::document()` + `devtools::test()` + `devtools::check()` before
  opening a PR; all three must succeed.
- Do **not** edit `man/` files or `NAMESPACE` directly — they are
  auto-generated by `devtools::document()`.
